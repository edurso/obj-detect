# Training an Object Detection Model with the [TensorFlow Object Detection API](https://github.com/tensorflow/models/tree/master/research/object_detection)

The training process can be broken down into several steps:

1. Dataset Creation
2. Workspace Setup
3. Model Configuration
4. Model Training
5. Model Exporting

## Dataset Creation

FRC Team 900 has created [this repository](https://github.com/FRC900/tensorflow_workspace) which contains useful datasets for past games. If looking to create a dataset, a tool such as [labelImg](https://github.com/tzutalin/labelImg) to annotate images. Note that the annotated images will need to reference a file named `label_map.pbtxt` that looks something as follows:

```textile
item {
    id: 1
    name: 'blue_cargo'
}

item {
    id: 2
    name: 'red_cargo'
}

item {
    id: 3
    name: 'blue_launchpad'
}
```

This file defines the classes that the model will be training on. Any number of classes can be added in this format provided there is an ample amount of data provided for accurate training.

The scripts [here](https://github.com/edurso/obj-detect/tree/master/scripts) can be used to finish creating the dataset.

The `img-from-video.py` script will take a video stream and split it into all of its frames. This is useful when gathering images to label.

The `clean-dataset.py` script will remove all files without a corresponding `*.xml` file. The XML files are the label files generated by labelImg in [Pascal VOC](https://www.section.io/engineering-education/understanding-pascal-voc-dataset/) format used by TensorFlow.

The last useful script here for now is `partition-dataset.py` which moves all of the images from a source directory to a new `images/` directory with `train/` and `test/` sub-directories for training and validation image and label files, respectively. Be sure to include the `-x` flag when running the script to also move the `*.xml` files to the training and testing sub-directories.

## Workspace Setup

After the dataset and `label_map.pbtxt` file have been created, the workspace can be set up. The [obj_detect.ipynb](https://github.com/edurso/obj-detect/blob/master/notebooks/obj_detect.ipynb) should be started in a GPU environment in the [Google Colab](https://colab.research.google.com/).

Look through the [model zoo](https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md) provided by TensorFlow and select a model. Copy the URL for the model (something like `http://download.tensorflow.org/models/object_detection/tf2/20200711/ssd_resnet50_v1_fpn_640x640_coco17_tpu-8.tar.gz`) and the name of the model (something like `ssd_resnet50_v1_fpn_640x640_coco17_tpu-8`) and put them in the first cell of the notebook in the `mlink` and `mname` variables respectively. Also update the `workdir` variable with the path to a google drive folder where the training process will take place. Note that the dataset will need to be uploaded here.

Run the first three cells.

## Model Configuration

Now, much of the file structure needed has been created. Follow the instructions in the next markdown cell to upload the dataset (images directory), `label_map.pbtxt`, and make the proper changes to `models/pipeline.config`.

The first cell should look something as follows:

```python
workdir = drivepath + 'tensorflow/test_project/'
mname = 'ssd_resnet50_v1_fpn_640x640_coco17_tpu-8' # from model zoo
mlink = 'http://download.tensorflow.org/models/object_detection/tf2/20200711/{}.tar.gz'.format(mname) # link to model zoo
```

The rest of the notebook can now be run.

## Model Training

While the rest of the notebook is running, `*.record` files will be created in the annotations directory.

While the training process is running, [TensorBoard](https://www.tensorflow.org/tensorboard) will be up to show training progress. It will need to be refreshed periodically throughout the training process.

## Model Exporting

The model will be exported to `${workdir}/exported_models/trained_model/`

The model is now ready to be converted to a [TensorRT](https://developer.nvidia.com/tensorrt) engine.
